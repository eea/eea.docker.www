#
# Front-end
#
apache:
  labels:
    io.rancher.scheduler.affinity:host_label: www=yes,frontend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.apache=yes
    eu.europa.eea.apache: "yes"
  tty: true
  image: eeacms/apache-eea-www
  links:
  - varnish:varnish
  volumes:
  - www-static-resources:/var/www-static-resources
  stdin_open: true
  volume_driver: ${VOLUME_DRIVER}
varnish:
  labels:
    io.rancher.scheduler.affinity:host_label: www=yes,frontend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.varnish=yes
    eu.europa.eea.varnish: "yes"
  tty: true
  image: eeacms/varnish-eea-www
  links:
  - anon:anon
  - auth:auth
  - download:download
  stdin_open: true
  environment:
  - BACKENDS=anon auth download
  - BACKENDS_PORT=8080
  - BACKENDS_PROBE_URL=/health.check
  - BACKENDS_PROBE_TIMEOUT=3s
  - BACKENDS_PROBE_INTERVAL=5s
  - BACKENDS_PROBE_WINDOW=5
  - BACKENDS_PROBE_THRESHOLD=3
  - BACKENDS_SAINT_MODE=true
  - DNS_ENABLED=true
#
# Plone Backends
#
anon:
  image: eeacms/www:${KGS_VERSION}
  environment:
    ZOPE_MODE: rel_client
    WARMUP_HEALTH_THRESHOLD: ${WARMUP}
  links:
  - postgres:postgres
  - relcached:relcached
  - memcached:memcached
  labels:
    io.rancher.sidekicks: anon-data
    io.rancher.scheduler.affinity:host_label: www=yes,backend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.anon=yes
    eu.europa.eea.anon: "yes"
  tty: true
  stdin_open: true
  volumes:
  - www-blobstorage:/data/blobstorage
  - www-downloads:/data/downloads
  - www-static-resources:/data/www-static-resources
  - www-eea-controlpanel:/data/eea.controlpanel
  volume_driver: ${VOLUME_DRIVER}
  volumes_from:
  - anon-data
anon-data:
  image: busybox
  labels:
    io.rancher.container.start_once: 'true'
  volumes:
  - /data
  tty: true
  stdin_open: true
  command: ["chown", "-R", "500:500", "/data"]
download:
  image: eeacms/www:${KGS_VERSION}
  environment:
    ZOPE_MODE: rel_client
    WARMUP_HEALTH_THRESHOLD: ${WARMUP}
  links:
  - postgres:postgres
  - relcached:relcached
  - memcached:memcached
  labels:
    io.rancher.sidekicks: download-data
    io.rancher.scheduler.affinity:host_label: www=yes,backend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.download=yes
    eu.europa.eea.download: "yes"
  tty: true
  stdin_open: true
  volumes:
  - www-blobstorage:/data/blobstorage
  - www-downloads:/data/downloads
  - www-static-resources:/data/www-static-resources
  - www-eea-controlpanel:/data/eea.controlpanel
  volume_driver: ${VOLUME_DRIVER}
  volumes_from:
  - download-data
download-data:
  image: busybox
  labels:
    io.rancher.container.start_once: 'true'
  volumes:
  - /data
  tty: true
  stdin_open: true
  command: ["chown", "-R", "500:500", "/data"]
auth:
  image: eeacms/www:${KGS_VERSION}
  environment:
    ZOPE_MODE: rel_client
    WARMUP_HEALTH_THRESHOLD: ${WARMUP}
  links:
  - postgres:postgres
  - relcached:relcached
  - memcached:memcached
  labels:
    io.rancher.sidekicks: auth-data
    io.rancher.scheduler.affinity:host_label: www=yes,backend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.auth=yes
    eu.europa.eea.auth: "yes"
  tty: true
  stdin_open: true
  volumes:
  - www-blobstorage:/data/blobstorage
  - www-downloads:/data/downloads
  - www-static-resources:/data/www-static-resources
  - www-eea-controlpanel:/data/eea.controlpanel
  volume_driver: ${VOLUME_DRIVER}
  volumes_from:
  - auth-data
auth-data:
  image: busybox
  labels:
    io.rancher.container.start_once: 'true'
  volumes:
  - /data
  tty: true
  stdin_open: true
  command: ["chown", "-R", "500:500", "/data"]
async:
  image: eeacms/www:${KGS_VERSION}
  environment:
    ZOPE_MODE: rel_async
    WARMUP_HEALTH_THRESHOLD: ${WARMUP}
  links:
  - memcached:memcached
  - relcached:relcached
  - postgres:postgres
  labels:
    io.rancher.sidekicks: async-data
    io.rancher.scheduler.affinity:host_label: www=yes,backend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.async=yes
    eu.europa.eea.async: "yes"
  tty: true
  stdin_open: true
  volumes:
  - www-blobstorage:/data/blobstorage
  - www-downloads:/data/downloads
  - www-static-resources:/data/www-static-resources
  - www-eea-controlpanel:/data/eea.controlpanel
  volume_driver: ${VOLUME_DRIVER}
  volumes_from:
  - async-data
async-data:
  image: busybox
  labels:
    io.rancher.container.start_once: 'true'
  volumes:
  - /data
  tty: true
  stdin_open: true
  command: ["chown", "-R", "500:500", "/data"]
#
# Cache
#
memcached:
  environment:
    MEMCACHED_MEMORY: '2048'
  labels:
    io.rancher.scheduler.affinity:host_label: www=yes,cache=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.memcached=yes
    eu.europa.eea.memcached: "yes"
  tty: true
  image: eeacms/memcached
  stdin_open: true
relcached:
  environment:
    MEMCACHED_MEMORY: '2048'
  labels:
    io.rancher.scheduler.global: 'true'
    io.rancher.scheduler.affinity:host_label: www=yes,cache=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.relcached=yes
    eu.europa.eea.relcached: "yes"
  tty: true
  image: eeacms/memcached
  stdin_open: true
#
# DB
#
postgres:
  image: rancher/dns-service
  external_links:
  - www-db/postgres-master:postgres
