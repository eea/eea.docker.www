#
# Front-end
#
apache:
  image: eeacms/apache-eea-www
  labels:
    io.rancher.scheduler.affinity:host_label: www=yes,frontend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.apache=yes
    eu.europa.eea.apache: "yes"
  environment:
    TZ: ${TZ}
  links:
  - varnish:varnish
  volumes:
  - www-static-resources:/var/www-static-resources
  volume_driver: ${VOLUME_DRIVER}
varnish:
  image: eeacms/varnish-eea-www:4.1
  labels:
    io.rancher.scheduler.affinity:host_label: www=yes,frontend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.varnish=yes
    eu.europa.eea.varnish: "yes"
  links:
  - anon:anon
  - auth:auth
  - download:download
  environment:
    CACHE_SIZE: "${VARNISH_CACHE_SIZE}"
    PARAM_VALUE: "${VARNISH_PARAMS}"
    BACKENDS: "anon auth download"
    BACKENDS_PORT: "8080"
    BACKENDS_PROBE_URL: "/health.check"
    BACKENDS_PROBE_TIMEOUT: "3s"
    BACKENDS_PROBE_INTERVAL: "5s"
    BACKENDS_PROBE_WINDOW: "5"
    BACKENDS_PROBE_THRESHOLD: "3"
    BACKENDS_SAINT_MODE: "true"
    DNS_ENABLED: "true"
    TZ: "${TZ}"
#
# Plone Backends
#
anon:
  image: eeacms/www:${KGS_VERSION}
  environment:
    ZOPE_MODE: rel_client
    WARMUP_HEALTH_THRESHOLD: ${WARMUP}
    TZ: ${TZ}
  links:
  - postgres:postgres
  - relcached:relcached
  - memcached:memcached
  labels:
    io.rancher.sidekicks: anon-data
    io.rancher.scheduler.affinity:host_label: www=yes,backend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.anon=yes
    eu.europa.eea.anon: "yes"
  volumes:
  - www-blobstorage:/data/blobstorage
  - www-downloads:/data/downloads
  - www-static-resources:/data/www-static-resources
  - www-eea-controlpanel:/data/eea.controlpanel
  volume_driver: ${VOLUME_DRIVER}
  volumes_from:
  - anon-data
anon-data:
  image: busybox
  labels:
    io.rancher.container.start_once: 'true'
  volumes:
  - /data
  tty: true
  stdin_open: true
  command: ["chown", "-R", "500:500", "/data"]
download:
  image: eeacms/www:${KGS_VERSION}
  environment:
    ZOPE_MODE: rel_client
    WARMUP_HEALTH_THRESHOLD: ${WARMUP}
    TZ: ${TZ}
  links:
  - postgres:postgres
  - relcached:relcached
  - memcached:memcached
  labels:
    io.rancher.sidekicks: download-data
    io.rancher.scheduler.affinity:host_label: www=yes,backend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.download=yes
    eu.europa.eea.download: "yes"
  volumes:
  - www-blobstorage:/data/blobstorage
  - www-downloads:/data/downloads
  - www-static-resources:/data/www-static-resources
  - www-eea-controlpanel:/data/eea.controlpanel
  volume_driver: ${VOLUME_DRIVER}
  volumes_from:
  - download-data
download-data:
  image: busybox
  labels:
    io.rancher.container.start_once: 'true'
  volumes:
  - /data
  tty: true
  stdin_open: true
  command: ["chown", "-R", "500:500", "/data"]
auth:
  image: eeacms/www:${KGS_VERSION}
  environment:
    ZOPE_MODE: rel_client
    WARMUP_HEALTH_THRESHOLD: ${WARMUP}
    TZ: ${TZ}
  links:
  - postgres:postgres
  - relcached:relcached
  - memcached:memcached
  labels:
    io.rancher.sidekicks: auth-data
    io.rancher.scheduler.affinity:host_label: www=yes,backend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.auth=yes
    eu.europa.eea.auth: "yes"
  volumes:
  - www-blobstorage:/data/blobstorage
  - www-downloads:/data/downloads
  - www-static-resources:/data/www-static-resources
  - www-eea-controlpanel:/data/eea.controlpanel
  volume_driver: ${VOLUME_DRIVER}
  volumes_from:
  - auth-data
auth-data:
  image: busybox
  labels:
    io.rancher.container.start_once: 'true'
  volumes:
  - /data
  tty: true
  stdin_open: true
  command: ["chown", "-R", "500:500", "/data"]
async:
  image: eeacms/www:${KGS_VERSION}
  environment:
    ZOPE_MODE: rel_async
    WARMUP_HEALTH_THRESHOLD: ${WARMUP}
    TZ: ${TZ}
  links:
  - memcached:memcached
  - relcached:relcached
  - postgres:postgres
  labels:
    io.rancher.sidekicks: async-data
    io.rancher.scheduler.affinity:host_label: www=yes,backend=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.async=yes
    eu.europa.eea.async: "yes"
  volumes:
  - www-blobstorage:/data/blobstorage
  - www-downloads:/data/downloads
  - www-static-resources:/data/www-static-resources
  - www-eea-controlpanel:/data/eea.controlpanel
  volume_driver: ${VOLUME_DRIVER}
  volumes_from:
  - async-data
async-data:
  image: busybox
  labels:
    io.rancher.container.start_once: 'true'
  volumes:
  - /data
  tty: true
  stdin_open: true
  command: ["chown", "-R", "500:500", "/data"]
#
# Cache
#
memcached:
  environment:
    MEMCACHED_MEMORY: '2048'
    TZ: ${TZ}
  labels:
    io.rancher.scheduler.affinity:host_label: www=yes,cache=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.memcached=yes
    eu.europa.eea.memcached: "yes"
  image: eeacms/memcached
relcached:
  environment:
    MEMCACHED_MEMORY: '2048'
    TZ: ${TZ}
  labels:
    io.rancher.scheduler.global: 'true'
    io.rancher.scheduler.affinity:host_label: www=yes,cache=yes
    io.rancher.scheduler.affinity:container_label_soft_ne: eu.europa.eea.relcached=yes
    eu.europa.eea.relcached: "yes"
  image: eeacms/memcached
#
# DB
#
postgres:
  image: rancher/dns-service
  external_links:
  - www-db/postgres-master:postgres
